# Faster R-CNN

  - Fast R-CNNì—ì„œëŠ” selective searchë¥¼ ì‚¬ìš©í•œ í›„ ROI pooling(strideë¥¼ ë‹¤ë¥´ê²Œ max pooling ì ìš©)ì„ í†µí•´ fc layerì— ë„£ê¸° ì „ feature vectorì˜ í¬ê¸°ë¥¼ ë§ì¶°ì¤Œ
  - Faster R-CNNì—ì„œëŠ” ì´ ê³¼ì •ì„ RPNìœ¼ë¡œ ëŒ€ì²´í•¨
  - í•µì‹¬ ì•„ì´ë””ì–´:
  - Fast R-CNNì—ì„œ selective searchê°€ í–ˆë˜ ì¼ì„ Region Proposal Network(RPN)ê°€ ëŒ€ì‹ í•¨ â†’ GPUë¡œ ROIê³„ì‚° ê°€ëŠ¥, ì—°ì‚°ëŸ‰ ê°ì†Œ
  - ì§„ì •í•œ ì˜ë¯¸ì˜ end-to-end object detection ëª¨ë¸ì„ ì œì‹œ


### ì „ì²´ ì•Œê³ ë¦¬ì¦˜
<img src="https://user-images.githubusercontent.com/33839093/109638891-e527d780-7b91-11eb-9237-581a036505a3.png" width="500">

ì…ë ¥ ì´ë¯¸ì§€ â†’ CNN(feature map ì¶”ì¶œ) â†’ RPNì— ì „ë‹¬í•´ ROIê³„ì‚° â†’ ROI pooling â†’ classification & bbox regression ìˆ˜í–‰

### RPN(Region Proposal Network)
<img src="https://user-images.githubusercontent.com/33839093/109639004-04266980-7b92-11eb-9fdb-c01202f9d6a2.png" width="500">

- pretrained CNNì„ ê±°ì³ ë‚˜ì˜¨ feature mapì€ ZFNet & 256-d VGG-16ì„ ê¸°ì¤€ìœ¼ë¡œ 512-dì„ ê°€ì§
- feature mapì€ kê°œì˜ anchor boxë¥¼ í†µí•´ ì˜ì—­ì„ ì •í•˜ê³ , classification layerì™€ bounding box regressionì„ ê±°ì³ ë¬¼ì²´ê°€ ìˆëŠ” ê³³ì„ í•™ìŠµí•¨
- classification layerëŠ” ë¬¼ì²´ê°€ ìˆëŠ”ì§€/ì—†ëŠ”ì§€ë§Œ í™•ì¸í•˜ê¸° ë•Œë¬¸ì— 2ê°œì˜ í´ë˜ìŠ¤ë¥¼ ê°€ì§
(ë§ì€ Faster R-CNN ì½”ë“œë“¤ì´ VGG-16ëª¨ë¸ì„ backboneìœ¼ë¡œ ì‚¬ìš©í•¨)

1) anchor targeting
<img src="https://user-images.githubusercontent.com/33839093/109639318-62534c80-7b92-11eb-95fe-2820c8ad61d6.png" width="300">

> - 3ê°œì˜ scaleê³¼ 3ê°œì˜ ratioë¥¼ ì‚¬ìš©í•´ 9ê°œì˜ anchor boxë¥¼ ë§Œë“¦
> - 50x50 feature mapì˜ ê° ì¤‘ì‹¬ì  ê¸°ì¤€ìœ¼ë¡œ 9ê°œì˜ anchor boxë¥¼ ë§Œë“¦

<img src="https://user-images.githubusercontent.com/33839093/109639865-10f78d00-7b93-11eb-88cb-c7b007424ed1.jpg" width="700">

> - 1ì„ labelingí•œ ê²½ìš° : iouê°€ ê°€ì¥ í° anchorì™€ iouê°€ 0.7ë³´ë‹¤ í° anchor
> - labelì´ 0, 1ì´ ì•„ë‹Œ anchorëŠ” í•™ìŠµì— ì‚¬ìš©ë˜ì§€ ì•ŠìŒ


2) prediction
<img src="https://user-images.githubusercontent.com/33839093/109640190-7a779b80-7b93-11eb-9191-53b3b3b6e3ec.jpg" width="700">

> - fully-connected layer ëŒ€ì‹  convolutional layerë¥¼ ì‚¬ìš© : ì…ë ¥ ì´ë¯¸ì§€ í¬ê¸°ì— ìƒê´€ì—†ì´ ì—°ì‚°ì„ í•˜ê¸° ìœ„í•´ì„œ
> - classification layerì—ëŠ” í•´ë‹¹ anchorê°€ ë¬¼ì²´ë¥¼ í¬í•¨í•˜ëŠ”ì§€ í™•ë¥  ê°’ì„ ì–»ìŒ
> - bbox regression layerì—ì„œëŠ” ì¢Œí‘œë¥¼ ì–»ìŒ

ğŸ‘‰ 2)ì—ì„œ predictioní•œ ê²°ê³¼ë¡œ 1)ì—ì„œ êµ¬í•œ ground truth labelê³¼ í•¨ê»˜ loss functionì„ í†µí•´ RPNì„ í•™ìŠµí•¨

3) loss function for RPN
<img src="https://user-images.githubusercontent.com/33839093/109640463-db9f6f00-7b93-11eb-80f4-8f528d499b4d.png" width="700">

> - Fast R-CNNê³¼ ë™ì¼í•˜ê²Œ multi task lossë¥¼ ì‚¬ìš©í•¨
> - ië²ˆì§¸ anchorì— ëŒ€í•´ì„œ GT(ground truth)ì™€ predictionê°’ì„ ë¹„êµí•´ RPNì˜ class(ë¬¼ì²´ê°€ ìˆëŠ”ì§€ ì—†ëŠ”ì§€)ì™€ boxì˜ ìœ„ì¹˜ë¥¼ í•™ìŠµ
> - L_cls : classificationì—ëŠ” log lossë¥¼ ì‚¬ìš©
> - L_reg : box regressionì—ëŠ” smooth L1 lossë¥¼ ì‚¬ìš©
> - GT label = 0ì´ë©´ ë°°ê²½ìœ¼ë¡œ ê°„ì£¼í•˜ê¸° ë•Œë¬¸ì—, ë’· í•­ì— 0ì´ ê³±í•´ì ¸ bbox regì´ í•™ìŠµë˜ì§€ ì•ŠìŒ
> - balancing weightì¸ ëŒë‹¤, N_cls, N_regë¥¼ í†µí•´ ë‘ í•­ì„ normalizeí•¨
> - bbox regressionì€ R-CNNê³¼ ë™ì¼í•œ ì‹ì„ ì‚¬ìš©í•¨
> <img src="https://user-images.githubusercontent.com/33839093/109640587-07225980-7b94-11eb-99a7-8704905a84f6.png" width="500">

### NMS(Non-Maximum Supression) & ROI Sampling
RPNë‹¨ê³„ì—ì„œ predictionëœ boxì— NMSì™€ ROI samplingì„ ê±°ì³ ìµœì¢… ROIë¥¼ ê²°ì •

- NMS
<img src="https://user-images.githubusercontent.com/33839093/109641324-ec9cb000-7b94-11eb-9296-d85f82d1ad4f.png" width="600">

> - ì¤‘ë³µë˜ëŠ” bboxë¥¼ ì œê±°í•˜ê¸° ìœ„í•´ ì‚¬ìš©
> - 2ë²ˆ ë‹¨ê³„ì—ì„œ predictioní•œ boxë“¤ì„ ROI scoreë¡œ ì •ë ¬í•œ ë’¤, ë†’ì€ ROI scoreë¥¼ ê°€ì§„ ë°•ìŠ¤ì™€ ê²¹ì¹œ ë°•ìŠ¤ë¥¼ ì§€ìš°ëŠ” ë°©ì‹
> - overlappingì— ëŒ€í•œ thresholdëŠ” ì£¼ë¡œ 0.6~0.9ë¥¼ ì‚¬ìš©

- ROI sampling
> - ë³´í†µ trainingì‹œì— NMSë¥¼ ê±°ì¹˜ë©´ 2000ê°œì˜ ROIê°€ ë‚¨ìŒ
> - **positive : negative ë¹„ìœ¨ì´ 1:1ì´ ë˜ë„ë¡ ROIë¥¼ ìƒ˜í”Œë§**
> - 256ê°œë¥¼ ìƒ˜í”Œë§í•˜ë©´, positive anchor 128ê°œ, negative anchor 128ê°œê°€ ìƒ˜í”Œë§ë¨
> - ë§Œì•½ positive anchorê°€ 128ê°œê°€ ì•ˆë˜ë©´, zero paddingì„ í•˜ê±°ë‚˜ IoUê°’ì´ ê°€ì¥ ë†’ì€ ë°•ìŠ¤ë¥¼ positiveë¡œ ì‚¬ìš©í•¨

### Faster R-CNN
> -  RPNì„ í†µí•´ ë½‘ì€ ROIëŠ” Fast R-CNNì—ì„œ selective searchê°€ ìˆ˜í–‰í•˜ë˜ ì¼ì„ ëŒ€ì‹ í•¨
> - Lossì— RPNì˜ íŒŒë¼ë¯¸í„° ê°’ì´ ì¶”ê°€ë¨: cls_loss, box_reg_loss

### ì„±ëŠ¥ ë° ê²°ë¡ 
<img src="https://user-images.githubusercontent.com/33839093/109642852-d42d9500-7b96-11eb-80f9-e8fc2bd96b90.png" width="600">

> - Fast R-CNNë³´ë‹¤ ì†ë„, ì„±ëŠ¥ì´ ëª¨ë‘ ê°œì„ ë¨
> - Faster R-CNNì˜ ì†ë„ëŠ” 7 fpsë¡œ ì‹¤ì‹œê°„ object detectionì„ í•˜ê¸°ì—ëŠ” ì í•©í•˜ì§€ ì•ŠìŒ
> - ROI poolingì—ì„œ ROIê°€ strideì— í•­ìƒ ë”± ë–¨ì–´ì§€ì§€ ì•Šê¸° ë•Œë¬¸ì— í”½ì…€ ì†ì‹¤ì´ ìˆìŒ
